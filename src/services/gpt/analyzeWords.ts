import OpenAI from 'openai';
import dotenv from 'dotenv';
import { TokenTiming, Word } from '../../types/hystory';
import { transformWordTiming } from '../../utils/transformWordTiming';

dotenv.config();

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export const analyzeWords = async (initialHistory: string, tokenTiming: TokenTiming[]): Promise<Word[]> => {
  // --- üîπ 5Ô∏è‚É£ –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å–ª–æ–≤–∞
  console.log('–†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å–ª–æ–≤–∞ ---');
  const words: Word[] = transformWordTiming(tokenTiming);
  // --- üîπ 6Ô∏è‚É£ –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–ª–æ–≤
  const prompt = `
–£ –º–µ–Ω—è –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ –Ω–µ–º–µ—Ü–∫–∏—Ö —Å–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞:
- **type** ‚Äî —á–∞—Å—Ç—å —Ä–µ—á–∏ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: Artikel, Substantiv, Verb, Adjektiv, Pronomen, Pr√§position, Numeral –∏ —Ç.–¥.)
- **baseForm** ‚Äî —Ñ–æ—Ä–º–∞ –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ, –∏–ª–∏ –ø–æ–ª–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è/—Ç–µ–∫—Å—Ç–∞, —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤ –ø–æ–ª–µ word.
  ‚Ä¢ –ï—Å–ª–∏ —Å–ª–æ–≤–æ –≤ –ø–æ–ª–µ word —Å—Ç–æ–∏—Ç –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ, –ø—Ä–∏–≤–µ–¥–∏ –µ–≥–æ –∫ —Ñ–æ—Ä–º–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ (Singular).
  ‚Ä¢ –î–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö ‚Äî —É–∫–∞–∂–∏ —Å –∞—Ä—Ç–∏–∫–ª–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "der Hund").  
  ‚Ä¢ –î–ª—è —á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö (Numeral) ‚Äî –∑–∞–ø–∏—à–∏ —á–∏—Å–ª–æ **–ø—Ä–æ–ø–∏—Å—å—é –ø–æ-–Ω–µ–º–µ—Ü–∫–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, "dreihunderttausend" –¥–ª—è 300.000, –∏–ª–∏ "drei√üig Grad Celsius" –¥–ª—è 30¬∞C, "zehn Prozent" –¥–ª—è 10%).
  ‚Ä¢ –î–ª—è –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä –∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è ‚Äî –∑–∞–ø–∏—à–∏ –ø–æ–ª–Ω—É—é —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Kilowattstunde" –¥–ª—è kWh).
  ‚Ä¢ –ï—Å–ª–∏ –≥–ª–∞–≥–æ–ª —Å –æ—Ç–¥–µ–ª—è–µ–º–æ–π –ø—Ä–∏—Å—Ç–∞–≤–∫–æ–π (trennbares Verb), —Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π —Ñ–æ—Ä–º—É **—Å –ø—Ä–∏—Å—Ç–∞–≤–∫–æ–π + –≥–ª–∞–≥–æ–ª –≤ –∏–Ω—Ñ–∏–Ω–∏—Ç–∏–≤–µ**. –ü—Ä–∏–º–µ—Ä—ã: "bereitet ... zu" ‚Üí "zubereiten" "packt ... ein" ‚Üí "einpacken" "r√§umt ... ein" ‚Üí "einr√§umen" "entscheidet sich" ‚Üí "sich entscheiden"
  ‚Ä¢ –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞ –±–µ–∑ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä ‚Äúbereitet‚Äù), –Ω–æ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤–∏–¥–Ω–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ = *zubereiten*, —Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –±–∞–∑–æ–≤—É—é —Ñ–æ—Ä–º—É –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.
  ‚Ä¢ –î–ª—è —Å–ª–æ–≤, –≥–¥–µ –Ω–µ—Ç ‚Äú–±–∞–∑–æ–≤–æ–π —Ñ–æ—Ä–º—ã‚Äù (–≥–ª–∞–≥–æ–ª—ã, –ø—Ä–µ–¥–ª–æ–≥–∏, —á–∞—Å—Ç–∏—Ü—ã, –º–µ–∂–¥–æ–º–µ—Ç–∏—è): –∫–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–æ–ª—è word

- **plural** ‚Äî —Ñ–æ—Ä–º–∞ –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ.  
  ‚Ä¢ –î–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö ‚Äî —É–∫–∞–∂–∏ —Å –∞—Ä—Ç–∏–∫–ª–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "die Hunde").  
  ‚Ä¢ –ï—Å–ª–∏ —Å–ª–æ–≤–æ –Ω–µ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–ª–∞–≥–æ–ª—ã, –ø—Ä–µ–¥–ª–æ–≥–∏, —á–∞—Å—Ç–∏—Ü—ã, –º–µ–∂–¥–æ–º–µ—Ç–∏—è), –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É "".
- **translation** ‚Äî –ø–µ—Ä–µ–≤–æ–¥ –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏—Å—Ç–æ—Ä–∏–∏ ---(${initialHistory})---.

–í—ã–≤–µ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ –º–∞—Å—Å–∏–≤–∞ JSON.
–ü—Ä–∏–º–µ—Ä –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
[
  { type: "Artikel", word: "Die", plural: "", baseForm: "", translation: "–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∞—Ä—Ç–∏–∫–ª—å –∂–µ–Ω—Å–∫–æ–≥–æ —Ä–æ–¥–∞" },
  { type: "Substantiv", word: "Traum", plural: "die Tr√§ume", baseForm: "der Traum", translation: "—Å–æ–Ω" },
  { type: "Verb", word: "haben", plural: "", baseForm: "", translation: "–∏–º–µ—Ç—å" } 
  { type: "Numeral", word: "500.000", plural: "", baseForm: "f√ºnfhunderttausend", translation: "–ø—è—Ç—å—Å–æ—Ç —Ç—ã—Å—è—á" }
  { type: "Numeral", word: "30¬∞C", plural: "", baseForm: "drei√üig Grad Celsius", translation: "—Ç—Ä–∏–¥—Ü–∞—Ç—å –≥—Ä–∞–¥—É—Å–æ–≤ –¶–µ–ª—å—Å–∏—è" }
]

–í–û–¢ –ú–ê–°–°–ò–í –°–õ–û–í:  ${JSON.stringify(words, null, 2)} 
**–í–∞–∂–Ω–æ:**
1. –ó–∞–ø–æ–ª–Ω—è–π –≤—Å–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞. –ù–∏ –æ–¥–Ω–æ –ø–æ–ª–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–æ.
2. –ï—Å–ª–∏ —Å–ª–æ–≤–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É "".
3. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Ç–æ–ª—å–∫–æ JSON**, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏–π.
4. **–ü–æ–ª—è word –ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨!**.
5. **–ü–æ–ª–µ baseForm –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å**.
–û—Ç–≤–µ—Ç **—Ç–æ–ª—å–∫–æ** –≤ JSON, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ —Ç–µ–∫—Å—Ç–∞ –≤–æ–∫—Ä—É–≥.
`;

  const completionWords = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.1,
  });

  const contentB = completionWords.choices[0]?.message?.content?.trim();
  if (!contentB) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç OpenAI –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–ª–æ–≤');

  try {
    // –ò—â–µ–º JSON-–º–∞—Å—Å–∏–≤ –≤ –æ—Ç–≤–µ—Ç–µ
    const jsonMatch = contentB.match(/\[.*\]/s);
    if (!jsonMatch) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ GPT (analyze words)');

    const parsedWords: Word[] = JSON.parse(jsonMatch[0]);
    return parsedWords; // <---- –≤–æ—Ç –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞!
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –¥–ª—è —Å–ª–æ–≤:', err);
    console.error('–û—Ç–≤–µ—Ç GPT:', contentB);
    return [];
  }
};
